<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é»˜æ›¸åŠ©æ‰‹ - Dictation Helper</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #fff; }
        legend { font-size: 1.2em; font-weight: bold; color: #333; padding: 0 10px; }
        label { display: block; margin-top: 10px; font-weight: 500; }
        .input-group { margin-bottom: 15px; }
        textarea { width: 98%; min-height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
        input[type="range"] { width: 100%; margin: 5px 0; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; transition: background-color 0.3s; }
        .main-controls button { background-color: #28a745; color: white; }
        .main-controls button:hover { background-color: #218838; }
        .upload-controls button { background-color: #007bff; color: white; margin-top: 5px; }
        .upload-controls button:hover { background-color: #0056b3; }
        .progress-display { background-color: #ffe0b2; padding: 15px; border-radius: 5px; text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold; color: #e65100; }
        small { display: block; margin-top: 5px; color: #666; }
    </style>
</head>
<body>

    <h1>ğŸ“ AI é»˜æ›¸åŠ©æ‰‹ (å¥å­ä¿®æ­£ç‰ˆ)</h1>

    <fieldset>
        <legend>1. ğŸ“ è¼¸å…¥é»˜æ›¸å…§å®¹ (Paste Words Here)</legend>
        <div class="input-group">
            <textarea id="wordInput" placeholder="åœ¨æ­¤è¼¸å…¥ã€‚è«‹æ³¨æ„ï¼š
1. æ¯å€‹ã€Œè©èªã€æˆ–ã€Œå¥å­ã€è«‹ä½¿ç”¨ã€Enter æ›è¡Œã€‘æˆ–ã€é€—è™Ÿã€‘åˆ†éš”ã€‚
2. å¥å­ä¸­é–“çš„ç©ºæ ¼ç¾åœ¨æœƒè¢«ä¿ç•™ (ä¾‹å¦‚: Apple is red)ã€‚"></textarea>
        </div>
        <div class="upload-controls">
            <button onclick="clearInput()">æ¸…ç©º</button>
            <button onclick="document.getElementById('fileUpload').click()">ä¸Šè¼‰æ–‡ä»¶ (TXT/PDF/åœ–ç‰‡)</button>
            <input type="file" id="fileUpload" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
            <button onclick="startCameraScan()">ğŸ“¸ ç›¸æ©Ÿæƒæ (éœ€æ”¯æ´)</button>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. âš™ï¸ é»˜æ›¸è¨­å®š (Settings)</legend>

        <div class="input-group">
            <label for="languageSelect">ğŸ—£ï¸ èªè¨€åŠå£éŸ³ (Language & Accent):</label>
            <select id="languageSelect">
                <option value="zh-HK">Cantonese (HK) ğŸ‡­ğŸ‡° - å»£æ±è©± (æ¨è–¦)</option>
                <option value="en-US">English (US) ğŸ‡ºğŸ‡¸</option>
                <option value="en-GB">English (UK) ğŸ‡¬ğŸ‡§</option>
                <option value="zh-CN">Mandarin (CN) ğŸ‡¨ğŸ‡³ - æ™®é€šè©± (å‚™ç”¨)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="voiceSelect">ğŸ”Š ç™¼éŸ³è€… (Voice):</label>
            <select id="voiceSelect" disabled>
                <option value="default">æ­£åœ¨åŠ è¼‰èªéŸ³è³‡æº...</option>
            </select>
            <small>æ³¨ï¼šå»ºè­°åœ¨æ‰‹æ©Ÿä¸Šé¸æ“‡**ç³»çµ±é è¨­**ä»¥ç¢ºä¿ç™¼éŸ³æˆåŠŸã€‚</small>
        </div>
        
        <div class="input-group">
            <label for="rateSlider">ğŸ¢ é–±è®€é€Ÿåº¦ (Reading Speed): <span id="rateValue">1.0x (æ¨™æº–)</span></label>
            <input type="range" id="rateSlider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('rateValue').innerText = this.value + 'x' + (this.value == 1.0 ? ' (æ¨™æº–)' : '')">
        </div>

        <div class="input-group">
            <label for="gapSlider">â³ è©èªé–“éš” (Gap Between Words): <span id="gapValue">5 ç§’</span></label>
            <input type="range" id="gapSlider" min="1" max="10" step="1" value="5" oninput="document.getElementById('gapValue').innerText = this.value + ' ç§’'">
        </div>
        
        <div class="input-group">
            <label for="repeatCountSlider">ğŸ” **é‡è¤‡æ¬¡æ•¸** (Repeat Count): <span id="repeatCountValue">1 æ¬¡</span></label>
            <input type="range" id="repeatCountSlider" min="1" max="5" step="1" value="1" oninput="document.getElementById('repeatCountValue').innerText = this.value + ' æ¬¡'">
            <small>ï¼ˆæ¯æ¬¡é‡è¤‡ä¹‹é–“ç›¸éš” 2 ç§’ã€‚ï¼‰</small>
        </div>

        <div class="input-group">
            <label>
                <input type="checkbox" id="readPunctuation">
                **è®€å‡ºæ¨™é»** (Read Punctuation)
            </label>
            <small>ï¼ˆä¾‹å¦‚è®€å‡º "Question Mark"ã€‚æœªå‹¾é¸æ™‚ï¼ŒèªéŸ³æœƒä¾æ¨™é»åœé “ä½†ä¸æœƒè®€å‡ºåç¨±ã€‚ï¼‰</small>
        </div>

    </fieldset>
    
    <fieldset>
        <legend>3. â–¶ï¸ åŸ·è¡Œæ“ä½œèˆ‡é€²åº¦</legend>
        <div class="main-controls">
            <button id="startButton">â–¶ï¸ é–‹å§‹é»˜æ›¸</button>
            <button id="pauseButton" disabled>â¸ï¸ æš«åœ / ç¹¼çºŒ</button>
            <button id="resetButton" disabled>ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>

        <div class="progress-display">
            æ­£åœ¨ç­‰å¾…èªéŸ³è³‡æº...
        </div>
    </fieldset>

    <script>
        // --- è¼”åŠ©åŠŸèƒ½ ---
        function clearInput() {
            document.getElementById('wordInput').value = '';
        }
        function startCameraScan() {
            alert('å•Ÿå‹•ç›¸æ©ŸæƒæåŠŸèƒ½... (æ­¤åŠŸèƒ½éœ€è¦é€²éšçš„ WebRTC åŠ OCR æœå‹™æ”¯æ´)');
        }

        // --- æ ¸å¿ƒ JavaScript é‚è¼¯ ---
        document.addEventListener('DOMContentLoaded', () => {
            const wordInput = document.getElementById('wordInput');
            const languageSelect = document.getElementById('languageSelect');
            const voiceSelect = document.getElementById('voiceSelect');
            const rateSlider = document.getElementById('rateSlider');
            const gapSlider = document.getElementById('gapSlider');
            const readPunctuation = document.getElementById('readPunctuation');
            const repeatCountSlider = document.getElementById('repeatCountSlider');
            
            const startButton = document.getElementById('startButton');
            const pauseButton = document.getElementById('pauseButton');
            const resetButton = document.getElementById('resetButton');
            const progressDisplay = document.querySelector('.progress-display');

            let wordsArray = [];
            let currentIndex = 0;
            let isPaused = false;
            let currentTimeout = null;
            let availableVoices = [];
            const REPEAT_GAP = 2000; 

            // æª¢æŸ¥ API æ”¯æ´
            if (!('speechSynthesis' in window)) {
                progressDisplay.textContent = "âŒ è­¦å‘Šï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆåŠŸèƒ½ã€‚";
                startButton.disabled = true;
                return;
            }

            const synth = window.speechSynthesis;

            // --- æ­¥é©Ÿ 1: åŠ è¼‰èªéŸ³ ---
            function populateVoiceList() {
                availableVoices = synth.getVoices();
                voiceSelect.innerHTML = '';
                voiceSelect.disabled = false;
                
                let defaultOption = document.createElement('option');
                defaultOption.value = 'system-default';
                defaultOption.textContent = 'ç³»çµ±é è¨­èªéŸ³ (æ¨è–¦)';
                voiceSelect.appendChild(defaultOption);

                availableVoices.forEach(voice => {
                    let option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                if (availableVoices.length > 0) {
                     progressDisplay.textContent = "âœ… èªéŸ³è³‡æºåŠ è¼‰å®Œæˆï¼Œå¯ä»¥é–‹å§‹é»˜æ›¸ã€‚";
                }
            }

            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoiceList;
            }
            setTimeout(() => {
                if (availableVoices.length === 0) populateVoiceList();
            }, 1000);
            
            languageSelect.addEventListener('change', populateVoiceList);

            // --- æ­¥é©Ÿ 2: æœ—è®€é‚è¼¯ ---
            function readWordWithRepeat(text, rate, totalRepeats, currentRepeat) {
                if (isPaused) return; 

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = parseFloat(rate);
                utterance.lang = languageSelect.value;

                const selectedVoiceName = voiceSelect.value;
                if (selectedVoiceName !== 'system-default') {
                    const selectedVoice = availableVoices.find(v => v.name === selectedVoiceName);
                    if (selectedVoice) utterance.voice = selectedVoice;
                } else {
                    utterance.voice = null;
                }
                
                progressDisplay.textContent = `ğŸ“š æ­£åœ¨è®€å‡º (${currentIndex}/${wordsArray.length}): ${text} (ç¬¬ ${currentRepeat} æ¬¡)`;

                utterance.onend = () => {
                    if (currentRepeat < totalRepeats) {
                        currentTimeout = setTimeout(() => {
                            readWordWithRepeat(text, rate, totalRepeats, currentRepeat + 1);
                        }, REPEAT_GAP); 
                    } else {
                        const gapTime = parseFloat(gapSlider.value) * 1000;
                        currentTimeout = setTimeout(nextWord, gapTime);
                    }
                };
                
                utterance.onerror = (event) => {
                    console.error('Error:', event);
                    const gapTime = parseFloat(gapSlider.value) * 1000;
                    currentTimeout = setTimeout(nextWord, gapTime);
                };

                synth.speak(utterance);
            }
            
            // --- æ­¥é©Ÿ 3: è™•ç†æ–‡å­—è¼¸å…¥ (BUG ä¿®å¾©é—œéµé») ---
            function prepareWords() {
                let text = wordInput.value; // ä¸è¦åœ¨é€™è£¡ trim æ•´å€‹æ–‡æœ¬ï¼Œä»¥å…å½±éŸ¿çµæ§‹

                // ğŸ”´ ä¿®æ­£ï¼šåˆ†å‰²é‚è¼¯
                // èˆŠä»£ç¢¼: text.split(/\s+/)  <- é€™è£¡æœƒæŠŠç©ºæ ¼åˆ‡é–‹ï¼Œå°è‡´å¥å­æ–·è£‚
                // æ–°ä»£ç¢¼: åƒ…ä½¿ç”¨ã€Œæ›è¡Œ (\n)ã€æˆ–ã€Œä¸­æ–‡/è‹±æ–‡é€—è™Ÿ (,, ï¼Œ)ã€ä¾†åˆ†å‰²
                let rawItems = text.split(/[\n\r,ï¼Œ]+/);

                wordsArray = rawItems
                    .map(item => {
                        let cleanItem = item.trim(); // å»é™¤å‰å¾Œç©ºæ ¼
                        
                        // è™•ç†æ¨™é»ç¬¦è™Ÿè¨­å®š
                        if (!readPunctuation.checked) {
                            // å¦‚æœä¸è®€æ¨™é»ï¼Œæˆ‘å€‘åªç§»é™¤é‚£äº›æœƒè¢«è®€å‡ºä¾†çš„ç¬¦è™Ÿ (å¦‚ ! ? ç­‰)ï¼Œä½†ä¿ç•™å¥å­çµæ§‹
                            // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœä¸å‹¾é¸ï¼Œé€šå¸¸ TTS å¼•æ“æœƒè‡ªå‹•å¿½ç•¥æ¨™é»ç™¼éŸ³ï¼Œåªåšåœé “
                            // ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘å¯ä»¥æ›¿æ›æ‰ä¸€äº›ç‰¹æ®Šç¬¦è™Ÿï¼Œä½†ä¿ç•™å­—æ¯é–“çš„ç©ºæ ¼
                        }
                        return cleanItem;
                    })
                    .filter(item => item.length > 0); // éæ¿¾æ‰ç©ºè¡Œ

                currentIndex = 0;
                isPaused = false;
            }

            function nextWord() {
                if (currentIndex >= wordsArray.length) {
                    progressDisplay.textContent = "âœ… é»˜æ›¸çµæŸï¼";
                    resetControls(true);
                    return;
                }
                if (isPaused) return;

                const currentWord = wordsArray[currentIndex];
                const repeatCount = parseInt(repeatCountSlider.value);
                
                // ç”±æ–¼å¥å­å¯èƒ½è¼ƒé•·ï¼Œé€™è£¡å°‡ currentIndex åŠ ä¸€ç§»åˆ°é€™è£¡é¡¯ç¤ºï¼Œé‚è¼¯ä¸è®Š
                readWordWithRepeat(currentWord, rateSlider.value, repeatCount, 1);
                currentIndex++; 
            }
            
            // --- æ­¥é©Ÿ 4: æŒ‰éˆ•äº‹ä»¶ ---
            startButton.addEventListener('click', () => {
                if (availableVoices.length === 0) {
                    progressDisplay.textContent = "âš ï¸ èªéŸ³è³‡æºä»åœ¨åŠ è¼‰ä¸­ï¼Œè«‹ç¨å€™...";
                    populateVoiceList();
                    return;
                }
                
                if (synth.speaking || isPaused) return;
                
                synth.cancel(); // æ¸…é™¤èˆŠèªéŸ³

                prepareWords();
                if (wordsArray.length === 0) {
                    alert('è«‹å…ˆè¼¸å…¥é»˜æ›¸å…§å®¹ï¼');
                    return;
                }

                startButton.textContent = 'é€²è¡Œä¸­...';
                startButton.disabled = true;
                pauseButton.disabled = false;
                resetButton.disabled = false;
                
                nextWord(); 
            });

            pauseButton.addEventListener('click', () => {
                if (isPaused) {
                    isPaused = false;
                    synth.resume(); 
                    pauseButton.textContent = 'â¸ï¸ æš«åœ';
                    const gapTime = 1; 
                    currentTimeout = setTimeout(nextWord, gapTime);
                } else {
                    isPaused = true;
                    synth.pause(); 
                    if (currentTimeout) clearTimeout(currentTimeout);
                    pauseButton.textContent = 'â–¶ï¸ ç¹¼çºŒ';
                    progressDisplay.textContent = `ğŸ›‘ å·²æš«åœ`;
                }
            });

            function resetControls(isFinished = false) {
                if (currentTimeout) clearTimeout(currentTimeout);
                synth.cancel();
                currentIndex = 0;
                isPaused = false;
                startButton.textContent = 'â–¶ï¸ é–‹å§‹é»˜æ›¸';
                startButton.disabled = false;
                pauseButton.textContent = 'â¸ï¸ æš«åœ / ç¹¼çºŒ';
                pauseButton.disabled = true;
                resetButton.disabled = true;
                if (!isFinished) progressDisplay.textContent = "è«‹æŒ‰ã€Œé–‹å§‹é»˜æ›¸ã€å•Ÿå‹•ã€‚";
            }

            resetButton.addEventListener('click', () => {
                resetControls(false);
            });
            
            resetControls(false);
            populateVoiceList();
        });
    </script>

</body>
</html>
